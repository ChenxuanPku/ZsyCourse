<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ‹©å¶æ¨¡æ‹Ÿå™¨ï¼šé‡åŒ–åå¥½å®éªŒ</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --love: #f472b6; --marry: #fbbf24; --text: #f1f5f9; }
        body { font-family: 'Inter', 'PingFang SC', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
        .card { background: var(--panel); border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 1px solid #334155; }
        .step { display: none; }
        .active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn { background: var(--accent); color: var(--bg); border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; font-size: 1rem; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(56, 189, 248, 0.4); }
        .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .person-node { background: #334155; padding: 12px; border-radius: 10px; cursor: pointer; text-align: center; border: 2px solid transparent; transition: 0.2s; }
        .person-node:hover { border-color: var(--accent); scale: 1.02; }
        .person-node.active-target { border-color: var(--love); background: rgba(244, 114, 182, 0.1); box-shadow: 0 0 15px rgba(244,114,182,0.3); }
        #console { background: #000; color: #4ade80; padding: 15px; border-radius: 8px; font-family: monospace; height: 100px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #1e293b; font-size: 0.85rem; line-height: 1.6; }
        .event-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 100; }
        .event-card { background: #fef08a; color: #854d0e; padding: 30px; border-radius: 15px; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .stat-label { font-size: 0.8rem; color: #94a3b8; }
        .report-section { margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; }
    </style>
</head>
<body>

<div class="event-overlay" id="event-layer">
    <div class="event-card">
        <h3 id="event-title">âš ï¸ éšæœºäººç”Ÿå˜é‡</h3>
        <p id="event-desc" style="font-size: 1.1rem; line-height: 1.5;"></p>
        <button class="btn" style="background:#854d0e; color:white;" onclick="closeEvent()">æ¥å—æŒ‘æˆ˜</button>
    </div>
</div>

<div class="container">
    <div id="p1" class="step active">
        <div style="text-align: center; padding: 40px 0;">
            <h1 style="font-size: 2.8rem; margin-bottom: 10px; color: var(--accent);">æ‹©å¶æ¨¡æ‹Ÿå™¨</h1>
            <p style="font-size: 1.2rem; color: #94a3b8;">æ¢ç©¶é‡åŒ–åå¥½å¦‚ä½•å†³å®šå¸‚åœºå‡è¡¡</p>
            <div class="card" style="text-align: left; line-height: 1.8; margin-top: 30px;">
                <p><b>å®éªŒå‰è¨€ï¼š</b></p>
                <p>æ‹©å¶ä¸ä»…æ˜¯æ„Ÿæ€§çš„å¸å¼•ï¼Œæ›´æ˜¯ä¸€åœºå…³äº<b>èµ„æºé…ç½®</b>ä¸<b>æ•ˆç”¨æœ€å¤§åŒ–</b>çš„ç¤¾ä¼šå®éªŒã€‚æœ¬å·¥å…·å°†å¸¦ä½ è¿›å…¥ä¸€ä¸ªâ€œæ ¡å›­æ‹©å¶å¸‚åœºâ€ï¼Œé€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µè§‚å¯Ÿä½ çš„é€‰æ‹©è·¯å¾„ï¼š</p>
                <ul>
                    <li><b>é‡åŒ–é˜¶æ®µï¼š</b>å°†æ¨¡ç³Šçš„åå¥½è½¬åŒ–ä¸ºç¡®å®šçš„æƒé‡ã€‚</li>
                    <li><b>è¯•é”™é˜¶æ®µï¼š</b>åœ¨ä¸»åŠ¨è¡¨ç™½ä¸ç»è¥ä¸­æ„Ÿå—äººé™…åšå¼ˆã€‚</li>
                    <li><b>å‡è¡¡é˜¶æ®µï¼š</b>é¢å¯¹ç°å®å‹åŠ›ï¼Œè§‚å¯Ÿæœ€åˆçš„ç†æƒ³å¦‚ä½•ä¸æœ€ç»ˆçš„åŒ¹é…è¾¾æˆå¦¥åã€‚</li>
                </ul>
            </div>
            <button class="btn" onclick="go(2)">è¿›å…¥å®éªŒå®¤</button>
        </div>
    </div>

    <div id="p2" class="step">
        <h2>ç¬¬ä¸€æ­¥ï¼šé‡åŒ–ä½ çš„æ•ˆç”¨åå¥½</h2>
        <p class="stat-label">è¯·åˆ†é…100ç‚¹â€œåœ¨æ„åˆ†â€ã€‚è¿™äº›åˆ†æ•°ä»£è¡¨äº†ä½ åœ¨æŒ‘é€‰ä¼´ä¾£æ—¶å„é¡¹æŒ‡æ ‡çš„ä¼˜å…ˆçº§ã€‚</p>
        <div class="card" id="weight-ui"></div>
        <button class="btn" onclick="go(3)">å®šä¹‰æˆ‘çš„åˆå§‹ç”»åƒ</button>
    </div>

    <div id="p3" class="step">
        <h2>ç¬¬äºŒæ­¥ï¼šå®šä¹‰ä½ çš„å¸‚åœºç«äº‰åŠ›</h2>
        <div class="card" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div><label>æ€§åˆ«</label><select id="u-gen"><option value="male">ç”·</option><option value="female">å¥³</option></select></div>
            <div><label>å¤–è²Œå¸å¼•åŠ› (1-10)</label><input type="range" id="u-app" min="1" max="10" value="6"></div>
            <div><label>æ•™è‚²èƒŒæ™¯</label><select id="u-edu"><option value="low">æ™®é€šæœ¬ç§‘</option><option value="mid">é‡ç‚¹é«˜æ ¡</option><option value="high">é¡¶å°–åæ ¡</option></select></div>
            <div><label>æ€§æ ¼/æƒ…ç»ªä»·å€¼</label><select id="u-soc"><option value="low">åå†…æ•›</option><option value="mid">è‰¯å¥½å¥‘åˆ</option><option value="high">æé«˜å…±æƒ…</option></select></div>
            <div><label>å®¶åº­èƒŒæ™¯</label><select id="u-fam"><option value="low">æ™®é€šå®¶åº­</option><option value="mid">ä¸­äº§é˜¶çº§</option><option value="high">èµ„æºä¼˜æ¸¥</option></select></div>
            <div><label>æœªæ¥é¢„æœŸæ”¶å…¥</label><select id="u-inc"><option value="low">ç¨³å®šç”Ÿæ´»</option><option value="mid">é«˜è–ªä¸­åš</option><option value="high">è´¢å¯Œçˆ†å‘åŠ›</option></select></div>
        </div>
        <button class="btn" onclick="startMarket()">å¯åŠ¨åŠ¨æ€åšå¼ˆå¸‚åœº</button>
    </div>

    <div id="p4" class="step">
        <div id="console">> æ ¡å›­åŒ¹é…ç¯å¢ƒåŠ è½½å®Œæ¯•...</div>
        <div class="card">
            <div id="target-detail" style="min-height: 80px; border-bottom: 1px solid #334155; margin-bottom: 15px; padding-bottom: 10px;">
                ç‚¹å‡»ä¸‹æ–¹è§’è‰²ç”»åƒæŸ¥çœ‹æ•ˆç”¨åŒ¹é…åº¦...
            </div>
            <div class="market-grid" id="market-grid"></div>
        </div>
        <div id="status-bar" style="text-align: center; color: var(--accent); font-weight: bold; margin-bottom:10px;">çŠ¶æ€ï¼šè‡ªç”±èº«</div>
    </div>

    <div id="p5" class="step">
        <h2 style="color:var(--marry)">æ‹©å¶å®éªŒæ·±åº¦æŠ¥å‘Š</h2>
        <div class="card" id="final-report"></div>
        <div class="card" style="border-top: 4px solid var(--accent);">
            <h3>ğŸ’¡ ä¸“å®¶çº§å»ºè®®</h3>
            <div id="advice-text" style="line-height: 1.8;"></div>
        </div>
        <button class="btn" onclick="location.reload()">é‡æ–°å¼€å¯æ¨¡æ‹Ÿ</button>
    </div>
</div>

<script>
const state = { user: null, market: [], target: null, bond: 0, tries: 0, history: [] };
const DIM = { app: 'å¤–è²Œ', edu: 'æ•™è‚²', soc: 'æ€§æ ¼', fam: 'å®¶åº­', inc: 'æ”¶å…¥' };
const weights = { app: 20, edu: 20, soc: 20, fam: 20, inc: 20 };

function go(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('p'+n).classList.add('active');
    if(n === 2) renderWeights();
}

function renderWeights() {
    const ui = document.getElementById('weight-ui'); ui.innerHTML = '';
    Object.keys(DIM).forEach(k => {
        ui.innerHTML += `<div style="margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between;">
                <label>${DIM[k]}</label><span id="v-${k}">${weights[k]}%</span>
            </div>
            <input type="range" min="0" max="100" value="${weights[k]}" oninput="updateWeights('${k}', this.value)" style="width:100%">
        </div>`;
    });
}
function updateWeights(k, v) { weights[k] = parseInt(v); document.getElementById('v-'+k).innerText = v + '%'; }

class Person {
    constructor(id, gender, isUser = false) {
        this.id = id; this.gender = gender; this.status = 'å•èº«';
        const lv = ['low', 'mid', 'high'];
        if(isUser) {
            this.stats = { 
                app: parseInt(document.getElementById('u-app').value),
                edu: document.getElementById('u-edu').value,
                soc: document.getElementById('u-soc').value,
                fam: document.getElementById('u-fam').value,
                inc: document.getElementById('u-inc').value
            };
            this.weights = {...weights};
        } else {
            this.stats = { app: Math.floor(Math.random()*9)+2, edu: lv[rand(3)], soc: lv[rand(3)], fam: lv[rand(3)], inc: lv[rand(3)] };
            this.weights = { app: rW(), edu: rW(), soc: rW(), fam: rW(), inc: rW() };
        }
    }
    getScore(other, phase = 'love') {
        const scoreMap = { low: 40, mid: 70, high: 95 };
        let s = 0, tw = 0;
        let w = {...this.weights};
        if(phase === 'marry') { w.fam *= 2; w.inc *= 2; } 
        for(let k in w) {
            let val = (k === 'app') ? other.stats[k]*10 : scoreMap[other.stats[k]];
            s += val * w[k]; tw += w[k];
        }
        return (s / tw) + (Math.random() * 6 - 3);
    }
}
const rand = (n) => Math.floor(Math.random()*n);
const rW = () => Math.random()*50 + 10;

function startMarket() {
    state.user = new Person(0, document.getElementById('u-gen').value, true);
    const targetGen = state.user.gender === 'male' ? 'female' : 'male';
    for(let i=1; i<=30; i++) state.market.push(new Person(i, targetGen));
    renderMarket(); go(4);
}

function renderMarket() {
    const grid = document.getElementById('market-grid'); grid.innerHTML = '';
    state.market.forEach(p => {
        const d = document.createElement('div');
        d.className = `person-node ${state.target?.id === p.id ? 'active-target' : ''}`;
        d.innerHTML = `<small>ID:${p.id}</small><br><b>${p.status}</b>`;
        d.onclick = () => showDetail(p);
        grid.appendChild(d);
    });
}

function showDetail(p) {
    state.temp = p;
    const v = document.getElementById('target-detail');
    const lMap = {low:'æ™®é€š', mid:'ä¼˜ç§€', high:'é¡¶å°–'};
    const util = state.user.getScore(p, 'love').toFixed(0);
    v.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <b>ID: ${p.id}</b> (é¢„æœŸåŒ¹é…åº¦: ${util}%)<br>
                <span class="stat-label">å¤–è²Œ:${p.stats.app} | æ•™è‚²:${lMap[p.stats.edu]} | æ€§æ ¼:${lMap[p.stats.soc]} | ç»æµ:${lMap[p.stats.inc]}</span>
            </div>
            ${renderActionBtn(p)}
        </div>
    `;
}

function renderActionBtn(p) {
    if(!state.target || state.target.id !== p.id) return `<button class="btn" onclick="act('confess')" style="width:90px; padding:8px;">è¡¨ç™½</button>`;
    if(state.bond < 100) return `<button class="btn" onclick="act('bond')" style="width:90px; padding:8px; background:var(--love)">ç»è¥æ„Ÿæƒ…</button>`;
    return `<button class="btn" onclick="act('marry')" style="width:90px; padding:8px; background:var(--marry)">æ±‚å©šé˜¶æ®µ</button>`;
}

const EVENTS = [
    { t: "å¯¹æ–¹å®¶é•¿é€šè¿‡ä¾§é¢äº†è§£äº†ä½ çš„èƒŒæ™¯ï¼Œæå‡ºäº†â€œé—¨å½“æˆ·å¯¹â€çš„æ‹…å¿§ã€‚", d: -35 },
    { t: "ä½ ä»¬ä¸€èµ·å®Œæˆäº†ä¸€ä¸ªé«˜éš¾åº¦çš„è¯¾é¢˜é¡¹ç›®ï¼Œé»˜å¥‘åº¦çˆ†å‘ã€‚", d: 25 },
    { t: "ç”±äºå¼‚åœ°å®ä¹ ï¼ŒåŒæ–¹å¯¹æœªæ¥çš„èŒä¸šè§„åˆ’å‡ºç°äº†ä¸¥é‡åˆ†æ­§ã€‚", d: -30 },
    { t: "å¯¹æ–¹åœ¨ä½è°·æœŸå¾—åˆ°äº†ä½ çš„æƒ…ç»ªæ”¯æŒï¼Œä¾èµ–åº¦æå‡ã€‚", d: 20 }
];

function act(type) {
    const p = state.temp; const c = document.getElementById('console');
    if(type === 'confess') {
        state.tries++;
        if(p.getScore(state.user, 'love') > 50) {
            state.target = p; p.status = 'æ‹çˆ±ä¸­'; state.bond = 35;
            c.innerHTML = `> [æˆåŠŸ] ä½ ä¸ ID ${p.id} å»ºç«‹äº†æ‹çˆ±å…³ç³»ã€‚`;
        } else {
            c.innerHTML = `> [è¢«æ‹’] ID ${p.id} è®¤ä¸ºä½ çš„å±æ€§åˆ†å¸ƒä¸åœ¨å…¶ä¼˜å…ˆè€ƒè™‘èŒƒå›´å†…ã€‚`;
        }
    } else if(type === 'bond') {
        state.bond += 25;
        if(Math.random() > 0.6) triggerEvent();
        if(state.bond >= 100) state.bond = 100;
        c.innerHTML = `> [åŠ¨æ€] äº’åŠ¨ä¸­... å½“å‰æƒ…æ„Ÿå¥‘åˆåº¦: ${state.bond}%`;
    } else if(type === 'marry') {
        if(p.getScore(state.user, 'marry') > 70) {
            p.status = 'å·²å©š'; finish(true);
        } else {
            c.innerHTML = `> [é—æ†¾] æ±‚å©šè¢«æ‹’ã€‚è¿›å…¥ç°å®é˜¶æ®µåï¼Œå¯¹æ–¹é‡æ–°è¯„ä¼°äº†ä½ ä»¬çš„èµ„æºåŒ¹é…åº¦ã€‚`;
            state.target = null; p.status = 'å·²åˆ†æ‰‹'; state.bond = 0;
        }
    }
    renderMarket(); showDetail(p);
}

function triggerEvent() {
    const ev = EVENTS[rand(EVENTS.length)]; state.bond += ev.d;
    document.getElementById('event-desc').innerText = ev.t;
    document.getElementById('event-layer').style.display = 'flex';
}
function closeEvent() { document.getElementById('event-layer').style.display = 'none'; }

function finish(success) {
    go(5); 
    const r = document.getElementById('final-report'); 
    const a = document.getElementById('advice-text');
    const p = state.target;

    // æ·±åº¦æ•°æ®è®¡ç®—
    const matchUtility = state.user.getScore(p, 'marry').toFixed(1);
    const scoreMap = { low: 1, mid: 2, high: 3 };
    
    // æ‰¾å‡ºå¦¥åç‚¹ï¼šæƒé‡æœ€é«˜ä½†å¯¹æ–¹å¾—åˆ†ä¸€èˆ¬çš„ç»´åº¦
    let maxWKey = Object.keys(weights).reduce((a, b) => weights[a] > weights[b] ? a : b);
    let compromiseVal = (maxWKey === 'app') ? p.stats.app / 3 : scoreMap[p.stats[maxWKey]];
    let isCompromised = compromiseVal < 2;

    r.innerHTML = `
        <div class="report-section">
            <p><b>æœ€ç»ˆä¼´ä¾£ï¼š</b> åŒå­¦ ID ${p.id}</p>
            <p><b>åŒ¹é…æ•ˆç”¨å€¼ï¼š</b> ${matchUtility} / 100</p>
            <p><b>å¸‚åœºåšå¼ˆï¼š</b> ä½ åœ¨è¾¾æˆå‡è¡¡å‰ï¼Œä¸»åŠ¨æ¢ç´¢äº† ${state.tries} æ¬¡æ½œåœ¨æœºä¼šã€‚</p>
        </div>
        <div class="report-section" style="background: rgba(56, 189, 248, 0.1);">
            <p><b>ğŸ” å®éªŒè§‚å¯Ÿï¼š</b></p>
            <p>ä½ åœ¨ç¬¬ä¸€é˜¶æ®µè®¾å®šçš„æ ¸å¿ƒè¯‰æ±‚æ˜¯ <b>${DIM[maxWKey]}</b> (${weights[maxWKey]}%)ã€‚</p>
            <p>åœ¨æœ€ç»ˆå‡è¡¡ä¸­ï¼Œè¯¥ç»´åº¦çš„å®é™…æ»¡è¶³åº¦ä¸º <b>${isCompromised ? 'éƒ¨åˆ†å¦¥å' : 'å®Œç¾å¥‘åˆ'}</b>ã€‚</p>
        </div>
    `;

    // äººæ€§åŒ–å»ºè®®é€»è¾‘
    let advice = "";
    if (success) {
        advice += `ä½ æˆåŠŸè¾¾æˆäº†ä»â€œæ„Ÿæ€§æ‹çˆ±â€åˆ°â€œç†æ€§å©šå§»â€çš„æƒŠé™©è·³è·ƒã€‚`;
        if (isCompromised) {
            advice += ` ä½ çš„è¡Œä¸ºè½¨è¿¹æ˜¾ç¤ºä½ æ˜¯ä¸€ä¸ª<b>â€œåŠ¡å®ç­–ç•¥è€…â€</b>ã€‚è™½ç„¶ä½ éå¸¸çœ‹é‡${DIM[maxWKey]}ï¼Œä½†åœ¨é¢å¯¹ç°å®å‹åŠ›ï¼ˆæ±‚å©šåˆ¤å®šï¼‰æ—¶ï¼Œä½ ç†æ™ºåœ°æ¥å—äº†ä¸€ä¸ªåœ¨è¯¥é¡¹ä¸Šå¹¶ä¸å®Œç¾ä½†ç»¼åˆæŠ—é£é™©èƒ½åŠ›è¾ƒå¼ºçš„å¯¹è±¡ã€‚è¿™ç§â€œç°åº¦å†³ç­–â€æ˜¯å©šå§»é•¿ä¹…çš„å…³é”®ã€‚`;
        } else {
            advice += ` ä½ å±äºæå°‘æ•°çš„<b>â€œç†æƒ³ä¸»ä¹‰èƒœå‡ºè€…â€</b>ã€‚ä½ ä¸ä»…åšå®ˆäº†å¯¹${DIM[maxWKey]}çš„é«˜è¦æ±‚ï¼Œè¿˜é¡ºåˆ©é€šè¿‡äº†ç°å®ç»´åº¦çš„æ ¸ç®—ã€‚è¿™é€šå¸¸æ„å‘³ç€ä½ è‡ªèº«çš„å¸‚åœºå¸å¼•åŠ›ï¼ˆåˆå§‹ç”»åƒï¼‰éå¸¸å‡è¡¡ã€‚`;
        }
    }

    if (state.tries > 10) {
        advice += `<br><br><b>å…³äºæ¢ç´¢æˆæœ¬ï¼š</b>ä½ çš„è¯•é”™æ¬¡æ•°è¾ƒé«˜ï¼Œè¿™åæ˜ äº†ä½ åœ¨æ‹©å¶åˆæœŸå­˜åœ¨ä¸€å®šçš„â€œä¿¡æ¯ä¸å¯¹ç§°â€æˆ–â€œå®šä½åå·®â€ã€‚è¿™ä¸å¯æ€•ï¼Œå› ä¸ºæ ¡å›­å®éªŒå…è®¸å¤±è´¥ï¼Œä½†åœ¨çœŸå®å¸‚åœºä¸­ï¼Œè¯·è­¦æƒ•è¿‡é«˜çš„æœç´¢æˆæœ¬å¸¦æ¥çš„ç–²æƒ«æ„Ÿã€‚`;
    }

    if (p.stats.inc === 'low' || p.stats.fam === 'low') {
        advice += `<br><br><b>ç”Ÿæ´»é¢„è­¦ï¼š</b>å½“å‰çš„ç¨³å®šåŒ¹é…å»ºç«‹åœ¨æé«˜çš„æƒ…æ„Ÿå¥‘åˆåº¦ï¼ˆ${state.bond}%ï¼‰åŸºç¡€ä¸Šã€‚ç”±äºä¼´ä¾£çš„ç»æµç»´åº¦å¾—åˆ†è¾ƒä½ï¼Œåœ¨æœªæ¥çœŸå®ç¤¾ä¼šçš„â€œéšæœºäº‹ä»¶â€å†²å‡»ä¸‹ï¼Œä½ ä»¬éœ€è¦æ¶ˆè€—æ¯”æ™®é€šå¤«å¦»æ›´å¤šçš„æ€§æ ¼æˆæœ¬æ¥æŠµæ¶ˆç‰©è´¨å‹åŠ›ã€‚`;
    }

    a.innerHTML = advice;
}
</script>
</body>
</html>
